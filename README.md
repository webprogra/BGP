# BGP
## 基本概念
1. BGP概念  
  全称是Border Gateway Protocol, 对应中文是边界网关协议，最新版本是BGPv4。BGP是互联网上一个核心的互联网去中心化自治路由协议。  
  属于应用层协议，其传输层使用TCP，连接是可靠的，默认端口号是179。
2. AS自治系统  
  指在一个（有时是多个）组织管辖下的所有IP网络和路由器的全体，它们对互联网执行共同的路由策略。也就是说，对于互联网来说，一个AS是一个独立的整体网络。每个AS有自己唯一的编号。
3. 其他概念  
  **AS PATH**:路由每通过一个AS范围都会产生一个记录。(路由防环机制)。  
  **EBGP**:外部BGP协议(EBGP)的主要作用是向外部路由器或AS提供更多信息。  
  **IBGP**:内部BGP协议(IBGP)的主要作用是向AS内部路由器提供更多信息。      
  **ISP**: 网络服务供应商。  
  **peer As, Customer AS, Provider AS**：零个或多个 c2p 链接，后跟零个或一个 p2p 链接，后跟零个或多个 p2c 链接。此外，s2s 链接可以出现在路径中任何位置的任意数量。  
  
  
  
## BGP的三张表  
1. 邻居表(adjancy table):保存所有的BGP邻居信息。  
2. BGP表(forwarding database):保存从每一个邻居学到的路由信息。  
3. 路由表(routing table):BGP默认不做负载均衡，会从BGP表中选出一条到达各个目标网络最优的路由，放入路由表保存。路由器只需按路由表保存的路由条目转发数据即可。  

## BGP基本三原则  
1. 当BGP路由建立邻居连接后，彼此将路由条目发送给邻居。  
2. 当目的网络确定时，AS_PATH最短路径具有路由优先权。
3. 当目的网络确定时，网络通告地址越具体(掩码越长)越有路由优先权。   
## BGP攻击（hijack）ps:分别对应BGP基本三原则
1. 闲置AS抢夺  
对外宣告不属于自己，但属于其他机构合法且*未被宣告*的网络  
2. 近邻AS通告抢夺  
利用物理位置*近邻特性*（更接近目标路由，盗用目标路由的地址），就近宣告不属于自己的网络，劫持近邻网络链路
3. 长掩码抢夺（吸虹效应）  
利用BGP选路长掩码优先的特性劫持所有可达网段全流量。使用比目标路由更长的掩码。  
4. AS_PATH hijack (沙丁鱼捕术)  
利用AS_PATH prepend可任意修改的特点,通过增加AS_PATH穿越AS数量抑制其路由优先级，将数据流向赶向目标网络。达到控制网络流量的目的。  
## BGP安全漏洞
1. BGP路由泄露  
BGP路由条目在不同的角色都有其合理通告范围，一旦BGP路由通告传播到其原本预期通告范围之外称之为路由泄露，而这会产生难以准确预料的结果。
发生泄漏造成的结果：  
a. 造成源网络中断  
b. 造成源网络和被指向网络中断  
c. 造成AS穿越/ISP穿越/MIMT等问题  

## 检测和防御

